<!-- Wappler include head-page="layouts/admin" fontawesome_5="cdn" bootstrap5="local" is="dmx-app" id="user_list" appConnect="local" components="{dmxIndexedDB:{},dmxDataTraversal:{},dmxFormatter:{},dmxDatastore:{},dmxBootstrap5TableGenerator:{},dmxBootstrap5Modal:{}}" -->

<div class="modal" id="modEditUser" is="dmx-bs5-modal" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-centered" role="document">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title">
                    <i class="fas fa-user-edit me-2"></i>Edit User
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <dmx-serverconnect id="scFetchSingleUser" url="/api/Users/singleUser" noload="true"></dmx-serverconnect>
                <form id="frmEditUser" method="post" is="dmx-serverconnect-form" action="/api/Users/updateSingleUser">
                    <!-- User Info Section -->
                    <div class="mb-4">
                        <div class="d-flex align-items-center mb-3">
                            <div class="section-icon me-2">
                                <i class="fas fa-info-circle text-primary"></i>
                            </div>
                            <h6 class="mb-0">User Information</h6>
                        </div>
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label for="inpFName" class="form-label fw-semibold">First Name</label>
                                <div class="input-group">
                                    <span class="input-group-text bg-primary text-white"><i class="fas fa-user"></i></span>
                                    <input type="text" class="form-control border-primary" id="inpFName" name="inpFName" placeholder="Enter first name" required="" dmx-bind:value="scFetchSingleUser.data.SingleFName">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <label for="inpLName" class="form-label fw-semibold">Last Name</label>
                                <div class="input-group">
                                    <span class="input-group-text bg-primary text-white"><i class="fas fa-user"></i></span>
                                    <input type="text" class="form-control border-primary" id="inpLName" name="inpLName" placeholder="Enter last name" dmx-bind:value="scFetchSingleUser.data.SingleLName">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <label for="inpPhone" class="form-label fw-semibold">Phone Number <span class="text-muted fw-normal">(Optional)</span></label>
                                <div class="input-group">
                                    <span class="input-group-text bg-primary text-white"><i class="fas fa-phone"></i></span>
                                    <input type="tel" class="form-control border-primary" id="inpPhone" name="inpPhone" placeholder="Enter phone number" pattern="[0-9]{3}-[0-9]{4}" title="Format: XXX-XXXX" dmx-bind:value="scFetchSingleUser.data.SinglePhone">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <label for="inpMobile" class="form-label fw-semibold">Mobile Number</label>
                                <div class="input-group">
                                    <span class="input-group-text bg-primary text-white"><i class="fas fa-mobile-alt"></i></span>
                                    <input type="tel" class="form-control border-primary" id="inpMobile" name="inpMobile" placeholder="Enter mobile number" pattern="[0-9]{4}-[0-9]{4}" title="Format: XXXX-XXXX" dmx-bind:value="scFetchSingleUser.data.SingleMobile">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <label for="inpEmail" class="form-label fw-semibold">Email</label>
                                <div class="input-group">
                                    <span class="input-group-text bg-primary text-white"><i class="fas fa-envelope"></i></span>
                                    <input type="tel" class="form-control border-primary" id="inpEmail" name="inpEmail" placeholder="Enter Email" pattern="[0-9]{4}-[0-9]{4}" title="Format: XXXX-XXXX" dmx-bind:value="scFetchSingleUser.data.SingleEmail">
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Address Section -->
                    <div class="mb-4">
                        <div class="d-flex align-items-center mb-3">
                            <div class="section-icon me-2">
                                <i class="fas fa-map-marked-alt text-primary"></i>
                            </div>
                            <h6 class="mb-0">Address Details</h6>
                        </div>
                        <div class="row g-3">
                            <div class="col-12">
                                <label for="inpAdd1" class="form-label fw-semibold">Address Line 1</label>
                                <div class="input-group">
                                    <span class="input-group-text bg-primary text-white"><i class="fas fa-home"></i></span>
                                    <input type="text" class="form-control border-primary" id="inpAdd1" name="inpAdd1" placeholder="Enter street address" dmx-bind:value="scFetchSingleUser.data.SingleAdd1">
                                </div>
                            </div>
                            <div class="col-12">
                                <label for="inpAdd2" class="form-label fw-semibold">Address Line 2 <span class="text-muted fw-normal">(Optional)</span></label>
                                <div class="input-group">
                                    <span class="input-group-text bg-primary text-white"><i class="fas fa-building"></i></span>
                                    <input type="text" class="form-control border-primary" id="inpAdd2" name="inpAdd2" placeholder="2nd line of Address" dmx-bind:value="scFetchSingleUser.data.SingleAdd2">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <label for="inpTown" class="form-label fw-semibold">Town/City</label>
                                <div class="input-group">
                                    <span class="input-group-text bg-primary text-white"><i class="fas fa-city"></i></span>
                                    <input type="text" class="form-control border-primary" id="inpTown" name="inpTown" placeholder="Enter town/city" dmx-bind:value="scFetchSingleUser.data.query.town1">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <label for="inpTown2" class="form-label fw-semibold">County<span class="text-muted fw-normal">(Optional)</span></label>
                                <div class="input-group">
                                    <span class="input-group-text bg-primary text-white"><i class="fas fa-map-marker-alt"></i></span>
                                    <input type="text" class="form-control border-primary" id="inpTown2" name="inpTown2" placeholder="Enter district" dmx-bind:value="scFetchSingleUser.data.query.county">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <label for="inpPostcode" class="form-label fw-semibold">Postcode</label>
                                <div class="input-group">
                                    <span class="input-group-text bg-primary text-white"><i class="fas fa-map-marker-alt"></i></span>
                                    <input type="text" class="form-control border-primary" id="inpPostcode" name="inpPostcode" placeholder="Enter district" dmx-bind:value="scFetchSingleUser.data.SinglePcode">
                                </div>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer bg-light">
                <button type="button" class="btn btn-light" data-bs-dismiss="modal">
                    <i class="fas fa-times me-1"></i>Cancel
                </button>
                <button type="submit" class="btn btn-primary" form="frmEditUser">
                    <i class="fas fa-save me-1"></i>Save Changes
                </button>
            </div>
        </div>
    </div>
</div>

<style>
    .modal-content {
        border: none;
        box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
    }

    .section-icon {
        width: 24px;
        height: 24px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.2rem;
    }

    .form-label {
        color: var(--bs-gray-700);
    }

    .input-group-text {
        border: 1px solid var(--bs-primary);
    }

    .form-control:focus {
        border-color: var(--bs-primary);
        box-shadow: 0 0 0 0.2rem rgba(var(--bs-primary-rgb), 0.25);
    }

    .modal-header {
        border-bottom: 0;
        border-top-left-radius: calc(0.5rem - 1px);
        border-top-right-radius: calc(0.5rem - 1px);
    }

    .modal-footer {
        border-top: 1px solid var(--bs-gray-200);
        border-bottom-left-radius: calc(0.5rem - 1px);
        border-bottom-right-radius: calc(0.5rem - 1px);
    }
</style>
<meta name="ac:route" content="/admin/user/user_list">

<!-- Define IndexedDB Store -->
<dmx-indexed-db id="usersDB" version="1" store="users" key="id" options="{
    'users': {
        'keyPath': 'id',
        'autoIncrement': true,
        'indexes': [
            { 'name': 'FirstName', 'keyPath': 'FirstName' },
            { 'name': 'LastName', 'keyPath': 'LastName' },
            { 'name': 'Email', 'keyPath': 'Email', 'unique': true },
            { 'name': 'Role', 'keyPath': 'Role' }
        ]
    }
}"></dmx-indexed-db>

<!-- Data View for sorting and filtering -->
<dmx-data-view id="dvUsers" dmx-bind:data="scAllUsers.data.repeat" sorton="varFName"></dmx-data-view>

<!-- Server Connection -->
<dmx-serverconnect id="scAllUsers" url="/api/Users/allUsers" autoload="true"></dmx-serverconnect>

<!-- Debug Value to track data flow -->
<dmx-value id="debugMode" dmx-bind:value="false"></dmx-value>
<div class="container-fluid py-4">
    <div class="row">
        <div class="col-12">
            <div class="card">
                <!-- Card Header with Controls -->
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="card-title mb-0">Users List</h5>
                    <div class="d-flex gap-2">
                        <!-- Search Input -->
                        <input type="search" class="form-control" id="searchInput" placeholder="Search users..." style="width: 250px;" dmx-on:input="dvUsers.filter = searchInput.value ? 
                           `varFName.toLowerCase().contains('${searchInput.value.toLowerCase()}') || 
                            varLName.toLowerCase().contains('${searchInput.value.toLowerCase()}') || 
                            Email.toLowerCase().contains('${searchInput.value.toLowerCase()}')`
                           : ''">

                        <!-- Buttons -->
                    </div>
                </div>

                <div class="card-body">
                    <!-- Loading State -->
                    <div class="text-center py-4" dmx-show="scAllUsers.loading">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="text-muted mt-2">Loading users data...</p>
                    </div>

                    <!-- Error State -->
                    <div class="alert alert-danger" dmx-show="scAllUsers.error">
                        <i class="fas fa-exclamation-circle me-2"></i>
                        Error loading users: <span dmx-text="scAllUsers.error.message"></span>
                    </div>

                    <!-- Data Table -->
                    <div class="table-responsive">
                        <table class="table table-bordered table-hover table-sm align-middle">
                            <thead>
                                <tr>
                                    <th></th>
                                    <th></th>
                                    <th></th>
                                    <th class="sorting" dmx-on:click="dvUsers.sort('varFName', dvUsers.sort.dir == 'desc' ? 'asc' : 'desc')" dmx-class:sorting_asc="dvUsers.sort.on == 'varFName' && dvUsers.sort.dir == 'asc'" dmx-class:sorting_desc="dvUsers.sort.on == 'varFName' && dvUsers.sort.dir == 'desc'">First Name</th>
                                    <th class="sorting" dmx-on:click="dvUsers.sort('varLName', dvUsers.sort.dir == 'desc' ? 'asc' : 'desc')" dmx-class:sorting_asc="dvUsers.sort.on == 'varLName' && dvUsers.sort.dir == 'asc'" dmx-class:sorting_desc="dvUsers.sort.on == 'varLName' && dvUsers.sort.dir == 'desc'">Last Name</th>
                                    <th class="sorting" dmx-on:click="dvUsers.sort('Email', dvUsers.sort.dir == 'desc' ? 'asc' : 'desc')" dmx-class:sorting_asc="dvUsers.sort.on == 'Email' && dvUsers.sort.dir == 'asc'" dmx-class:sorting_desc="dvUsers.sort.on == 'Email' && dvUsers.sort.dir == 'desc'">Email</th>
                                    <th class="sorting" dmx-on:click="dvUsers.sort('JoinDate', dvUsers.sort.dir == 'desc' ? 'asc' : 'desc')" dmx-class:sorting_asc="dvUsers.sort.on == 'JoinDate' && dvUsers.sort.dir == 'asc'" dmx-class:sorting_desc="dvUsers.sort.on == 'JoinDate' && dvUsers.sort.dir == 'desc'">Join Date</th>
                                    <th class="sorting" dmx-on:click="dvUsers.sort('Role', dvUsers.sort.dir == 'desc' ? 'asc' : 'desc')" dmx-class:sorting_asc="dvUsers.sort.on == 'Role' && dvUsers.sort.dir == 'asc'" dmx-class:sorting_desc="dvUsers.sort.on == 'Role' && dvUsers.sort.dir == 'desc'">Role</th>

                                </tr>
                            </thead>
                            <tbody is="dmx-repeat" dmx-generator="bs5table" dmx-bind:repeat="dvUsers.data" id="tableRepeat2">
                                <tr>
                                    <td dmx-text="dvUsers.data[$index].varId"></td>
                                    <td class="align-middle"><button id="btn1" class="btn btn-sm btn-primary" dmx-on:click="run([{run:{outputType:'text',action:`modEditUser.frmEditUser.reset(true)`}},{run:{outputType:'text',action:`modEditUser.scFetchSingleUser.load({user_id: varId})`}},{run:{outputType:'text',action:`modEditUser.show()`}},{wait:{delay:100}}])">
                                            <i class="fas fa-edit fa-lg"></i>
                                        </button>&nbsp;</td>
                                    <td class="align-middle">
                                        <img dmx-bind:src="'\\upload\\images\\profiles\\'+dvUsers.data[$index].varImage+'.jpg'" class="rounded-circle" width="40" height="40" onerror="this.src='https://via.placeholder.com/40?text=User'" dmx-bind:alt="varFName + ' ' + varLName">
                                    </td>
                                    <td dmx-text="dvUsers.data[$index].varFName" class="align-middle"></td>
                                    <td dmx-text="varLName" class="align-middle"></td>
                                    <td dmx-text="varEmail" class="align-middle"></td>
                                    <td dmx-text="dvUsers.data[$index].varJoinDate.formatDate('dd-MM-yyyy')" class="align-middle"></td>
                                    <td dmx-text="varRole" class="align-middle"></td>

                                </tr>
                            </tbody>
                            <tfoot>
                                <tr>
                                    <td>&nbsp;</td>
                                    <td>&nbsp;</td>
                                    <td>&nbsp;</td>
                                    <td>&nbsp;</td>
                                    <td>&nbsp;</td>
                                    <td>&nbsp;</td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    .sorting {
        cursor: pointer;
        position: relative;
        padding-right: 1.5rem;
    }

    .sorting::after {
        content: "↕";
        position: absolute;
        right: 0.5rem;
        opacity: 0.3;
    }

    .sorting_asc::after {
        content: "↑";
        opacity: 1;
    }

    .sorting_desc::after {
        content: "↓";
        opacity: 1;
    }

    /* Adjust table sizing */
    .table {
        font-size: 0.875rem;
        /* Smaller font size */
    }

    .table> :not(caption)>*>* {
        padding: 0.5rem;
        /* Reduce cell padding */
    }

    /* Header styling */
    .table thead th {
        background-color: var(--bs-gray-100);
        font-weight: 600;
        padding-top: 0.5rem;
        padding-bottom: 0.5rem;
    }

    /* Adjust image size */
    .table img.rounded-circle {
        width: 32px;
        height: 32px;
        object-fit: cover;
    }
</style>