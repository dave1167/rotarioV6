<!-- Wappler include head-page="layouts/admin" fontawesome_5="cdn" bootstrap5="local" is="dmx-app" id="user_list" appConnect="local" components="{dmxIndexedDB:{},dmxDataTraversal:{},dmxFormatter:{},dmxDatastore:{},dmxBootstrap5TableGenerator:{},dmxBootstrap5Modal:{},dmxValidator:{},dmxStateManagement:{}}" -->
<dmx-query-manager id="query1"></dmx-query-manager>

<dmx-serverconnect id="scAllUsers" url="/api/Users/allUsers" autoload="true" dmx-param:sort="query1.data.sort" dmx-param:dir="query1.data.dir"></dmx-serverconnect><dmx-serverconnect id="scFetchSingleUser" url="/api/Users/singleUser" noload="true"></dmx-serverconnect>
<div class="modal" id="modEditUser" is="dmx-bs5-modal" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-centered" role="document">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title">
                    <i class="fas fa-user-edit me-2"></i>Edit User
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">

                <form id="frmEditUser" method="post" is="dmx-serverconnect-form" action="/api/Users/updateSingleUser" dmx-on:success="browser1.goto('/admin/user/user_list');modEditUser.hide();notifies1.success('User Updated')">
                    <!-- User Info Section -->
                    <div class="mb-4">
                        <div class="d-flex align-items-center mb-3">
                            <div class="section-icon me-2">
                                <i class="fas fa-info-circle text-primary"></i>
                            </div>
                            <h6 class="mb-0 fw-bolder">User Information</h6>
                        </div>
                        <div class="row g-3">
                            <!-- Profile Image -->
                            <div class="col-md-3 text-center">
                                <img dmx-bind:src="'\\upload\\images\\profiles\\'+scFetchSingleUser.data.query.imageName+'.jpg'" class="rounded-circle border border-2 border-primary mb-2" width="100" height="100" /100?text=User'" alt="Profile Image">
                            </div>
                            <!-- User Details -->
                            <div class="col-md-9">
                                <div class="row g-2">
                                    <div class="col-md-6">
                                        <label for="inpFName" class="form-label">First Name</label>
                                        <div class="input-group">
                                            <span class="input-group-text bg-primary text-white"><i class="fas fa-user"></i></span>
                                            <input type="text" class="form-control border-primary" id="inpFName" name="inpFName" placeholder="First name" required="" dmx-bind:value="scFetchSingleUser.data.SingleFName">
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <label for="inpLName" class="form-label">Last Name</label>
                                        <div class="input-group">
                                            <span class="input-group-text bg-primary text-white"><i class="fas fa-user"></i></span>
                                            <input type="text" class="form-control border-primary" id="inpLName" name="inpLName" placeholder="Last name" dmx-bind:value="scFetchSingleUser.data.SingleLName">
                                        </div>
                                    </div>
                                    <div class="col-12">
                                        <label for="inpEmail" class="form-label">Email</label>
                                        <div class="input-group">
                                            <span class="input-group-text bg-primary text-white"><i class="fas fa-envelope"></i></span>
                                            <input type="email" class="form-control border-primary" id="inpEmail" name="inpEmail" placeholder="Email address" dmx-bind:value="scFetchSingleUser.data.SingleEmail">
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <label for="inpPhone" class="form-label">Phone</label>
                                        <div class="input-group">
                                            <span class="input-group-text bg-primary text-white"><i class="fas fa-phone"></i></span>
                                            <input type="tel" class="form-control border-primary" id="inpPhone" name="inpPhone" dmx-bind:value="scFetchSingleUser.data.SinglePhone">
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <label for="inpMobile" class="form-label">Mobile</label>
                                        <div class="input-group">
                                            <span class="input-group-text bg-primary text-white"><i class="fas fa-mobile-alt"></i></span>
                                            <input type="tel" class="form-control border-primary" id="inpMobile" name="inpMobile" dmx-bind:value="scFetchSingleUser.data.SingleMobile">
                                            <input type="hidden" class="form-control border-primary" id="inpUserId" name="inpUserId" placeholder="XXXX-XXXX" dmx-bind:value="scFetchSingleUser.data.query.uid">
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Address Section -->
                    <div class="mb-4">
                        <div class="d-flex align-items-center mb-3">
                            <div class="section-icon me-2">
                                <i class="fas fa-map-marked-alt text-primary"></i>
                            </div>
                            <h6 class="mb-0 fw-bolder">Address Details</h6>
                        </div>
                        <div class="row g-2">
                            <div class="col-12">
                                <label for="inpAdd1" class="form-label">Address Line 1</label>
                                <div class="input-group">
                                    <span class="input-group-text bg-primary text-white"><i class="fas fa-home"></i></span>
                                    <input type="text" class="form-control border-primary" id="inpAdd1" name="inpAdd1" placeholder="Street address" dmx-bind:value="scFetchSingleUser.data.SingleAdd1">
                                </div>
                            </div>
                            <div class="col-12">
                                <label for="inpAdd2" class="form-label">Address Line 2</label>
                                <div class="input-group">
                                    <span class="input-group-text bg-primary text-white"><i class="fas fa-building"></i></span>
                                    <input type="text" class="form-control border-primary" id="inpAdd2" name="inpAdd2" placeholder="Apartment, suite, etc." dmx-bind:value="scFetchSingleUser.data.SingleAdd2">
                                </div>
                            </div>
                            <div class="col-md-4">
                                <label for="inpTown" class="form-label">Town/City</label>
                                <div class="input-group">
                                    <span class="input-group-text bg-primary text-white"><i class="fas fa-city"></i></span>
                                    <input type="text" class="form-control border-primary" id="inpTown" name="inpTown" placeholder="Town/City" dmx-bind:value="scFetchSingleUser.data.query.town1">
                                </div>
                            </div>
                            <div class="col-md-4">
                                <label for="inpTown2" class="form-label">Town 2nd Line (Optional)</label>
                                <div class="input-group">
                                    <span class="input-group-text bg-primary text-white"><i class="fas fa-map-marker-alt"></i></span>
                                    <input type="text" class="form-control border-primary" id="inpTown2" name="inpTown2" placeholder="Town 2nd Line " dmx-bind:value="scFetchSingleUser.data.query.town2">
                                </div>
                            </div>
                            <div class="col-md-4">
                                <label for="inpCounty" class="form-label">County</label>
                                <div class="input-group">
                                    <span class="input-group-text bg-primary text-white"><i class="fas fa-map-marker-alt"></i></span>
                                    <input type="text" class="form-control border-primary" id="inpCounty" name="inpCounty" placeholder="County" dmx-bind:value="scFetchSingleUser.data.query.county">
                                </div>
                            </div>
                            <div class="col-md-4">
                                <label for="inpPostcode" class="form-label">Postcode</label>
                                <div class="input-group">
                                    <span class="input-group-text bg-primary text-white"><i class="fas fa-map-pin"></i></span>
                                    <input type="text" class="form-control border-primary" id="inpPostcode" name="inpPostcode" placeholder="Postcode" dmx-bind:value="scFetchSingleUser.data.SinglePcode">
                                </div>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer bg-light">
                <button type="button" class="btn btn-light" data-bs-dismiss="modal">
                    <i class="fas fa-times me-1"></i>Cancel
                </button>
                <button type="submit" class="btn btn-primary" form="frmEditUser">
                    <i class="fas fa-save me-1"></i>Save Changes
                </button>
            </div>
        </div>
    </div>
</div>
<style>
    .modal-content {
        border: none;
        box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
    }

    .section-icon {
        width: 24px;
        height: 24px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.2rem;
    }

    .form-label {
        color: var(--bs-gray-700);
    }

    .input-group-text {
        border: 1px solid var(--bs-primary);
    }

    .form-control:focus {
        border-color: var(--bs-primary);
        box-shadow: 0 0 0 0.2rem rgba(var(--bs-primary-rgb), 0.25);
    }

    .modal-header {
        border-bottom: 0;
        border-top-left-radius: calc(0.5rem - 1px);
        border-top-right-radius: calc(0.5rem - 1px);
    }

    .modal-footer {
        border-top: 1px solid var(--bs-gray-200);
        border-bottom-left-radius: calc(0.5rem - 1px);
        border-bottom-right-radius: calc(0.5rem - 1px);
    }
</style>
<meta name="ac:route" content="/admin/user/user_list">

<!-- Define IndexedDB Store -->
<dmx-indexed-db id="usersDB" version="1" store="users" key="id" options="{
    'users': {
        'keyPath': 'id',
        'autoIncrement': true,
        'indexes': [
            { 'name': 'FirstName', 'keyPath': 'FirstName' },
            { 'name': 'LastName', 'keyPath': 'LastName' },
            { 'name': 'Email', 'keyPath': 'Email', 'unique': true },
            { 'name': 'Role', 'keyPath': 'Role' }
        ]
    }
}"></dmx-indexed-db>

<!-- Data View for sorting and filtering -->
<dmx-data-view id="dvUsers" dmx-bind:data="scAllUsers.data.repeat" filter="varFName.contains(searchInput.value, true)||varLName.contains(searchInput.value, true)||varEmail.contains(searchInput.value, true)||varRole.contains(searchInput.value, true)" sortOn="varLName"></dmx-data-view>

<!-- Server Connection -->


<!-- Debug Value to track data flow -->
<div class="container-fluid py-4">
    <div class="row">
        <div class="col-12">
            <div class="card">
                <!-- Card Header with Controls -->
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="card-title mb-0">Users List</h5>
                    <div class="d-flex gap-2">
                        <!-- Search Input -->



                        <!-- Buttons -->
                        <i class="fas fa-search fa-lg"></i><input type="search" class="form-control" id="searchInput" placeholder="Search users..." style="width: 250px;" dmx-on:input="dvUsers.filter = searchInput.value ? 
                           `varFName.toLowerCase().contains('${searchInput.value.toLowerCase()}') || 
                            varLName.toLowerCase().contains('${searchInput.value.toLowerCase()}') || 
                            Email.toLowerCase().contains('${searchInput.value.toLowerCase()}')`
                           : ''">
                    </div>
                </div>

                <div class="card-body">
                    <div class="row">
                        <div class="col">
                            <p class="text-muted mt-2">Loading users data...</p>
                        </div>
                        <div class="col align-self-center"></div>
                    </div>
                    <!-- Loading State -->
                    <div class="text-center py-4" dmx-show="scAllUsers.loading">


                    </div>

                    <!-- Error State -->
                    <div class="alert alert-danger" dmx-show="scAllUsers.error">
                        <i class="fas fa-exclamation-circle me-2"></i>
                        Error loading users: <span dmx-text="scAllUsers.error.message"></span>
                    </div>

                    <!-- Data Table -->
                    <div class="table-responsive">
                        <table class="table table-striped table-bordered table-hover table-sm">
                            <thead>
                                <tr>
                                    <th class="sorting visually-hidden" dmx-on:click="query1.set('sort','dvUsers');query1.set('dir',query1.data.dir == 'desc' ? 'asc' : 'desc')" dmx-class:sorting_asc="query1.data.sort=='dvUsers' &amp;&amp; query1.data.dir == 'asc'" dmx-class:sorting_desc="query1.data.sort=='dvUsers' &amp;&amp; query1.data.dir == 'desc'">undefined</th>
                                    <th dmx-on:click="query1.set('sort','null');query1.set('dir',query1.data.dir == 'desc' ? 'asc' : 'desc')" dmx-class:sorting_asc="query1.data.sort=='null' &amp;&amp; query1.data.dir == 'asc'" dmx-class:sorting_desc="query1.data.sort=='null' &amp;&amp; query1.data.dir == 'desc'"></th>
                                    <th class="sorting visually-hidden" dmx-on:click="query1.set('sort','null');query1.set('dir',query1.data.dir == 'desc' ? 'asc' : 'desc')" dmx-class:sorting_asc="query1.data.sort=='null' &amp;&amp; query1.data.dir == 'asc'" dmx-class:sorting_desc="query1.data.sort=='null' &amp;&amp; query1.data.dir == 'desc'">undefined</th>
                                    <th class="sorting" dmx-on:click="query1.set('sort','dvUsers');query1.set('dir',query1.data.dir == 'desc' ? 'asc' : 'desc')" dmx-class:sorting_asc="query1.data.sort=='scAllUsers.data.repeat[$index].varFName'&amp;&amp;query1.data.dir=='asc'" dmx-class:sorting_desc="query1.data.sort=='scAllUsers.data.repeat[$index].varFName'&amp;&amp;query1.data.dir=='desc'">First Name</th>
                                    <th class="sorting" dmx-on:click="query1.set('sort','dvUsers');query1.set('dir',query1.data.dir == 'desc' ? 'asc' : 'desc')" dmx-class:sorting_asc="query1.data.sort=='dvUsers' && dvUsers.data.dir == 'asc'" dmx-class:sorting_desc="dvUsers.data.sort=='dvUsers' && query1.data.dir == 'desc'">Last Name</th>
                                    <th class="sorting" dmx-on:click="query1.set('sort','dvUsers');query1.set('dir',query1.data.dir == 'desc' ? 'asc' : 'desc')" dmx-class:sorting_asc="query1.data.sort=='dvUsers' && query1.data.dir == 'asc'" dmx-class:sorting_desc="query1.data.sort=='dvUsers' && query1.data.dir == 'desc'">Email</th>
                                    <th class="sorting" dmx-on:click="query1.set('sort','dvUsers');query1.set('dir',query1.data.dir == 'desc' ? 'asc' : 'desc')" dmx-class:sorting_asc="query1.data.sort=='dvUsers' && query1.data.dir == 'asc'" dmx-class:sorting_desc="query1.data.sort=='dvUsers' && query1.data.dir == 'desc'">Join Date</th>
                                    <th class="sorting" dmx-on:click="query1.set('sort','varRole');query1.set('dir',query1.data.dir == 'desc' ? 'asc' : 'desc')" dmx-class:sorting_asc="query1.data.sort=='varRole' && query1.data.dir == 'asc'" dmx-class:sorting_desc="query1.data.sort=='varRole' && query1.data.dir == 'desc'">Role</th>
                                </tr>
                            </thead>
                            <tbody is="dmx-repeat" dmx-generator="bs5table" dmx-bind:repeat="dvUsers.data" id="tableRepeat1" dmx-state="query1" dmx-sort="sort" dmx-order="dir">
                                <tr>
                                    <td class="visually-hidden" dmx-text="dvUsers.data[$index].varId"></td>
                                    <td class="align-middle"><button id="btn1" class="btn btn-primary align-self-center" dmx-on:click="run([{run:{outputType:'text',action:`modEditUser.frmEditUser.reset(true)`}},{alert:{message:`scFetchSingleUser.data.query.userIDut+\'ok\'+varId`}},{wait:{delay:300}},{run:{outputType:'text',action:`modEditUser.show()`}},{run:{outputType:'text',action:`scFetchSingleUser.load({user_id: varId})`}},{wait:{delay:100}}])">
                                            <i class="fas fa-edit fa-lg" dmx-style:color="'white'"></i>
                                        </button>&nbsp;</td>
                                    <td class="align-middle">
                                        <img dmx-bind:src="'\\upload\\images\\profiles\\'+dvUsers.data[$index].varImage+'.jpg'" class="rounded-circle" width="40" height="40" text="User'&quot;" dmx-bind:alt="varFName + ' ' + varLName">
                                    </td>
                                    <td class="align-middle" dmx-text="dvUsers.data[$index].varFName"></td>
                                    <td class="align-middle" dmx-text="dvUsers.data[$index].varLName"></td>
                                    <td class="align-middle" dmx-text="dvUsers.data[$index].varEmail"></td>
                                    <td class="align-middle" dmx-text="dvUsers.data[$index].varJoinDate.formatDate('dd-MM-yyyy')"></td>
                                    <td class="align-middle" dmx-text="varRole"></td>
                                </tr>
                            </tbody>
                            <tfoot>
                                <tr>
                                    <td>&nbsp;</td>
                                    <td>&nbsp;</td>
                                    <td>&nbsp;</td>
                                    <td>&nbsp;</td>
                                    <td>&nbsp;</td>
                                    <td>&nbsp;</td>
                                    <td>&nbsp;</td>
                                    <td>&nbsp;</td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    .sorting {
        cursor: pointer;
        position: relative;
        padding-right: 1.5rem;
    }

    .sorting::after {
        content: "↕";
        position: absolute;
        right: 0.5rem;
        opacity: 0.3;
    }

    .sorting_asc::after {
        content: "↑";
        opacity: 1;
    }

    .sorting_desc::after {
        content: "↓";
        opacity: 1;
    }

    /* Adjust table sizing */
    .table {
        font-size: 0.875rem;
        /* Smaller font size */
    }

    .table> :not(caption)>*>* {
        padding: 0.5rem;
        /* Reduce cell padding */
    }

    /* Header styling */
    .table thead th {
        background-color: var(--bs-gray-100);
        font-weight: 600;
        padding-top: 0.5rem;
        padding-bottom: 0.5rem;
    }

    /* Adjust image size */
    .table img.rounded-circle {
        width: 32px;
        height: 32px;
        object-fit: cover;
    }
</style>